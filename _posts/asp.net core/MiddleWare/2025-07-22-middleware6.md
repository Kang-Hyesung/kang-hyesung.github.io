---
title: "[6] UseWhen ì„ ì´ìš©í•œ ì¡°ê±´ë¶€ ì‹¤í–‰"
date: 2025-07-22 17:04 +0900
author: hyesung
---

## [ASP.NET Core] ì¡°ê±´ì— ë”°ë¼ ë¯¸ë“¤ì›¨ì–´ ì‹¤í–‰í•˜ê¸°: Use vs UseWhen

ëª¨ë“  ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­(Request)ì„ ì²˜ë¦¬í•˜ê³  ì‘ë‹µ(Response)ì„ ë³´ë‚´ëŠ” ì¼ë ¨ì˜ ê³¼ì •ì„ ê±°ì¹œë‹¤. ASP.NET Coreì—ì„œëŠ” ì´ ê³¼ì •ì„ **ë¯¸ë“¤ì›¨ì–´ íŒŒì´í”„ë¼ì¸(Middleware Pipeline)** ì„ í†µí•´ ê´€ë¦¬í•˜ë©°, ê°œë°œìëŠ” ì´ íŒŒì´í”„ë¼ì¸ì— í•„ìš”í•œ ê¸°ëŠ¥ë“¤ì„ ë¯¸ë“¤ì›¨ì–´ í˜•íƒœë¡œ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ `Use` í™•ì¥ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ì‹¤í–‰ë  ë¯¸ë“¤ì›¨ì–´ë¥¼ íŒŒì´í”„ë¼ì¸ì— ë“±ë¡í•œë‹¤. í•˜ì§€ë§Œ íŠ¹ì • ì¡°ê±´ì—ì„œë§Œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‹¤í–‰í•˜ê³  ì‹¶ì„ ë•Œë„ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • URL ê²½ë¡œì—ë§Œ ë¡œê¹…ì„ ì ìš©í•˜ê±°ë‚˜, ìš”ì²­ í—¤ë”ì— ì¸ì¦ í† í°ì´ ìˆì„ ë•Œë§Œ ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ê²½ìš°ë‹¤.

ì´ëŸ´ ë•Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë°”ë¡œ `UseWhen` ë©”ì„œë“œë‹¤. ì´ë²ˆ ê¸€ì—ì„œëŠ” `UseWhen`ì´ ë¬´ì—‡ì´ë©° `Use`ì™€ ì–´ë–»ê²Œ ë‹¤ë¥¸ì§€, ê·¸ë¦¬ê³  ì–´ë–¤ ìƒí™©ì—ì„œ ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ì•Œì•„ë³¸ë‹¤.

### Use vs. UseWhen: í•µì‹¬ ì°¨ì´ì 

ë‘ ë©”ì„œë“œ ëª¨ë‘ ë¯¸ë“¤ì›¨ì–´ë¥¼ ìš”ì²­ íŒŒì´í”„ë¼ì¸ì— ì¶”ê°€í•˜ì§€ë§Œ, ì‹¤í–‰ë˜ëŠ” ë°©ì‹ì— ê·¼ë³¸ì ì¸ ì°¨ì´ê°€ ìˆë‹¤.

  - **`Use`**: íŒŒì´í”„ë¼ì¸ì— ë“±ë¡ëœ ìˆœì„œì— ë”°ë¼ **ëª¨ë“  ìš”ì²­**ì— ëŒ€í•´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‹¤í–‰í•œë‹¤. ê°€ì¥ ì¼ë°˜ì ì¸ ë¯¸ë“¤ì›¨ì–´ ë“±ë¡ ë°©ì‹ì´ë‹¤.
  - **`UseWhen`**: íŠ¹ì • ì¡°ê±´(`Predicate`)ì„ ë§Œì¡±í•˜ëŠ” ìš”ì²­ì— ëŒ€í•´ì„œë§Œ ë¯¸ë“¤ì›¨ì–´ì˜ **ë¶„ê¸°(Branch)** ë¥¼ ì‹¤í–‰í•œë‹¤. ì¡°ê±´ì´ ë§Œì¡±ë˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ë¶„ê¸°ëŠ” ê±´ë„ˆë›´ë‹¤.

-----

### `UseWhen`ì˜ ì‘ë™ ë°©ì‹ ğŸ”

`UseWhen`ì€ ì¡°ê±´ë¶€ë¡œ íŒŒì´í”„ë¼ì¸ì„ ë¶„ê¸°í•˜ì—¬ íŠ¹ì • ë¡œì§ì„ ì‹¤í–‰í•œ ë’¤, ë‹¤ì‹œ ì›ë˜ì˜ ì£¼ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ íë¦„ì„ ë˜ëŒë¦¬ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.

1.  **ì´ˆê¸° ë¯¸ë“¤ì›¨ì–´ ì‹¤í–‰**: ìš”ì²­ì´ íŒŒì´í”„ë¼ì¸ì— ì§„ì…í•˜ë©´ `UseWhen` ì´ì „ì˜ ë¯¸ë“¤ì›¨ì–´ë“¤ì´ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ëœë‹¤.
2.  **`UseWhen` ì¡°ê±´ í™•ì¸**: `UseWhen`ì— ì •ì˜ëœ ì¡°ê±´(ì˜ˆ: ìš”ì²­ í—¤ë” ê°’, ì¿¼ë¦¬ ë¬¸ìì—´, ê²½ë¡œ ë“±)ì„ í™•ì¸í•œë‹¤. ì´ ì¡°ê±´ì€ `HttpContext`ë¥¼ ì¸ìë¡œ ë°›ì•„ `bool` ê°’ì„ ë°˜í™˜í•˜ëŠ” ëŒë‹¤ì‹ìœ¼ë¡œ ì •ì˜ëœë‹¤.
3.  **ì¡°ê±´ë¶€ ë¯¸ë“¤ì›¨ì–´ ë¶„ê¸° ì‹¤í–‰**:
      * **ì¡°ê±´ì´ ì°¸(true)ì¼ ê²½ìš°**: `UseWhen`ì— ì •ì˜ëœ ë¯¸ë“¤ì›¨ì–´ ë¶„ê¸°ê°€ ì‹¤í–‰ëœë‹¤. ì´ ë¶„ê¸° íŒŒì´í”„ë¼ì¸ì´ ëª¨ë‘ ì‹¤í–‰ëœ í›„, ìš”ì²­ì€ ë‹¤ì‹œ **ì£¼ ì²´ì¸(Main Chain)** ìœ¼ë¡œ ëŒì•„ê°€ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ë¥¼ ê³„ì† ì‹¤í–‰í•œë‹¤.
      * **ì¡°ê±´ì´ ê±°ì§“(false)ì¼ ê²½ìš°**: ë¯¸ë“¤ì›¨ì–´ ë¶„ê¸°ë¥¼ ê±´ë„ˆë›°ê³ , ìš”ì²­ì€ ì¦‰ì‹œ ì£¼ ì²´ì¸ì˜ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ë¡œ ë„˜ì–´ê°„ë‹¤.

ì—¬ê¸°ì„œ \*\*ì£¼ ì²´ì¸(Main Chain)\*\*ì´ë€, ì¡°ê±´ê³¼ ê´€ê³„ì—†ì´ ëª¨ë“  ìš”ì²­ì´ ê³µí†µìœ¼ë¡œ ê±°ì¹˜ëŠ” í•µì‹¬ ë¯¸ë“¤ì›¨ì–´ íŒŒì´í”„ë¼ì¸ì„ ì˜ë¯¸í•œë‹¤.

#### ì˜ˆì œ ì½”ë“œë¡œ ì‚´í´ë³´ê¸°

`Program.cs` íŒŒì¼ì— ë‹¤ìŒê³¼ ê°™ì´ ë¯¸ë“¤ì›¨ì–´ë¥¼ êµ¬ì„±í•˜ì—¬ `UseWhen`ì˜ ë™ì‘ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```csharp
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

// 'username' ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰ë˜ëŠ” ë¯¸ë“¤ì›¨ì–´ ë¶„ê¸°
app.UseWhen(
    // 1. ì¡°ê±´: ìš”ì²­ ì¿¼ë¦¬ì— "username" í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
    context => context.Request.Query.ContainsKey("username"),

    // 2. ë¯¸ë“¤ì›¨ì–´ ë¶„ê¸°: ì¡°ê±´ì´ ì°¸ì¼ ë•Œ ì‹¤í–‰í•  íŒŒì´í”„ë¼ì¸ì„ êµ¬ì„±í•œë‹¤.
    appBranch => {
        appBranch.Use(async (context, next) =>
        {
            await context.Response.WriteAsync("Hello from Middleware branch. ");
            await next(); // ë¶„ê¸° ë‚´ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ ë˜ëŠ” ì£¼ ì²´ì¸ìœ¼ë¡œ ì œì–´ë¥¼ ë„˜ê¸´ë‹¤.
        });
    });

// 3. ì£¼ ì²´ì¸: UseWhen ì¡°ê±´ê³¼ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰ëœë‹¤.
app.Run(async context =>
{
    await context.Response.WriteAsync("Hello from middleware at main chain.");
});

app.Run();
```

#### ì‹¤í–‰ ê²°ê³¼ ë¶„ì„

  - **`http://localhost:5000`ìœ¼ë¡œ ìš”ì²­ ì‹œ:**

      - `username` ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë¯€ë¡œ `UseWhen`ì˜ ì¡°ê±´ì€ `false`ë‹¤.
      - ë¯¸ë“¤ì›¨ì–´ ë¶„ê¸°ëŠ” ì‹¤í–‰ë˜ì§€ ì•Šê³  `app.Run` ë¯¸ë“¤ì›¨ì–´ë§Œ ì‹¤í–‰ëœë‹¤.
      - **ì‘ë‹µ**: `Hello from middleware at main chain.`

  - **`http://localhost:5000/?username=gemini`ìœ¼ë¡œ ìš”ì²­ ì‹œ:**

      - `username` ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë¯€ë¡œ `UseWhen`ì˜ ì¡°ê±´ì€ `true`ë‹¤.
      - `UseWhen`ì˜ ë¯¸ë“¤ì›¨ì–´ ë¶„ê¸°ê°€ ì‹¤í–‰ë˜ì–´ ì²« ë²ˆì§¸ ì‘ë‹µì„ ì‘ì„±í•œë‹¤.
      - ë¶„ê¸° ì‹¤í–‰ í›„, ì£¼ ì²´ì¸ìœ¼ë¡œ ëŒì•„ì™€ `app.Run` ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ëœë‹¤.
      - **ì‘ë‹µ**: `Hello from Middleware branch. Hello from middleware at main chain.`

-----

### ì–¸ì œ `UseWhen`ì„ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?

`UseWhen`ì€ ë‹¤ìŒê³¼ ê°™ì´ ìš”ì²­ì˜ íŠ¹ì • ì†ì„±ì— ë”°ë¼ ë‹¤ë¥¸ íŒŒì´í”„ë¼ì¸ ë¡œì§ì„ ì ìš©í•´ì•¼ í•  ë•Œ ë§¤ìš° ìœ ìš©í•˜ë‹¤.

  - **ì¸ì¦ ë¶„ê¸° ì²˜ë¦¬**: ìš”ì²­ í—¤ë”ì— `Authorization` í† í°ì´ ì¡´ì¬í•  ë•Œë§Œ ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.
  - **íŠ¹ì • ê²½ë¡œ ë¡œê¹…**: `/api` ì™€ ê°™ì´ íŠ¹ì • ê²½ë¡œë¡œ ì‹œì‘í•˜ëŠ” ìš”ì²­ì— ëŒ€í•´ì„œë§Œ ìƒì„¸í•œ ìš”ì²­/ì‘ë‹µ ë¡œê¹… ë¯¸ë“¤ì›¨ì–´ë¥¼ ì ìš©í•  ìˆ˜ ìˆë‹¤.
  - **A/B í…ŒìŠ¤íŒ…**: íŠ¹ì • ì¿ í‚¤ë‚˜ í—¤ë” ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©ì ê·¸ë£¹ì„ ë‚˜ëˆ„ì–´ ì„œë¡œ ë‹¤ë¥¸ ë¯¸ë“¤ì›¨ì–´ íŒŒì´í”„ë¼ì¸ì„ íƒ€ê²Œ í•˜ì—¬ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë‹¤.

-----

### Java Springì—ì„œëŠ”? ğŸ¤”

Java Spring í™˜ê²½, íŠ¹íˆ Spring Bootì—ì„œëŠ” ASP.NET Coreì˜ `UseWhen`ê³¼ ê°™ì´ íŒŒì´í”„ë¼ì¸ ìì²´ë¥¼ ë¶„ê¸°í•˜ëŠ” ëª…ì‹œì ì¸ ë©”ì„œë“œëŠ” ì—†ë‹¤. ëŒ€ì‹ , **í•„í„°(Filter)** ë˜ëŠ” **ì¸í„°ì…‰í„°(HandlerInterceptor)** ë‚´ë¶€ì—ì„œ ì¡°ê±´ë¶€ ë¡œì§ì„ êµ¬í˜„í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì¼í•œ ëª©í‘œë¥¼ ë‹¬ì„±í•œë‹¤.

Springì˜ `Filter`ëŠ” `DispatcherServlet`ì— ë„ë‹¬í•˜ê¸° ì „ ëª¨ë“  ìš”ì²­ì„ ê°€ë¡œì±„ëŠ” ì—­í• ì„ í•œë‹¤. ê°œë°œìëŠ” ì»¤ìŠ¤í…€ í•„í„°ë¥¼ ë§Œë“¤ê³ , ê·¸ í•„í„°ì˜ `doFilter` ë©”ì„œë“œ ì•ˆì—ì„œ `if` ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ ì›í•˜ëŠ” ì¡°ê±´ì„ ê²€ì‚¬í•  ìˆ˜ ìˆë‹¤.

#### Spring Boot Filter ì˜ˆì œ

ASP.NET Core ì˜ˆì œì™€ ìœ ì‚¬í•˜ê²Œ, `username` ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œë§Œ íŠ¹ì • ë¡œì§ì„ ì‹¤í–‰í•˜ëŠ” `Filter`ë¥¼ ë§Œë“¤ì–´ë³´ì.

**1. ì»¤ìŠ¤í…€ í•„í„° ì‘ì„± (`ConditionalLogicFilter.java`)**

```java
import jakarta.servlet.*;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.stereotype.Component;

import java.io.IOException;

@Component
public class ConditionalLogicFilter implements Filter {

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletRequest httpRequest = (HttpServletRequest) request;

        // C# UseWhenì˜ ì¡°ê±´ê³¼ ë™ì¼í•œ ë¡œì§
        if (httpRequest.getParameter("username") != null) {
            // ì¡°ê±´ì´ ì°¸ì¼ ë•Œ ì‹¤í–‰í•  ë¡œì§
            HttpServletResponse httpResponse = (HttpServletResponse) response;
            httpResponse.getWriter().write("Hello from Filter's conditional branch. ");
        }

        // ì£¼ ì²´ì¸(Main Chain)ìœ¼ë¡œ ìš”ì²­ì„ ê³„ì† ì „ë‹¬í•œë‹¤.
        chain.doFilter(request, response);
    }
}
```

**2. ì»¨íŠ¸ë¡¤ëŸ¬ ì‘ì„± (`MainController.java`)**

Springì—ì„œ `app.Run`ê³¼ ë¹„ìŠ·í•œ ì—­í• ì€ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í•¸ë“¤ëŸ¬ ë©”ì„œë“œê°€ ìˆ˜í–‰í•œë‹¤.

```java
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class MainController {

    @GetMapping("/")
    public String handleMainRequest() {
        // í•„í„° ì‹¤í–‰ í›„, ì£¼ ì²´ì¸ì— í•´ë‹¹í•˜ëŠ” ë¡œì§
        return "Hello from Controller at main chain.";
    }
}
```

#### ë™ì‘ ë°©ì‹ ë¹„êµ

  - **ASP.NET Core `UseWhen`**: í”„ë ˆì„ì›Œí¬ ìˆ˜ì¤€ì—ì„œ íŒŒì´í”„ë¼ì¸ì˜ **êµ¬ì¡° ìì²´ë¥¼ ë¶„ê¸°**í•œë‹¤.
  - **Java Spring `Filter`**: ë‹¨ì¼ í•„í„° **ë‚´ë¶€ì—ì„œ `if` ë¬¸ì„ í†µí•´ ë¡œì§ì„ ë¶„ê¸°**í•œë‹¤. ìš”ì²­ì€ ëª¨ë“  í•„í„° ì²´ì¸ì„ í†µê³¼í•˜ì§€ë§Œ, í•„í„° ì•ˆì˜ ì½”ë“œê°€ ì¡°ê±´ì— ë”°ë¼ ì‹¤í–‰ë  ë¿ì´ë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ ë‘ í”„ë ˆì„ì›Œí¬ ëª¨ë‘ 'ì¡°ê±´ë¶€ ë¡œì§ ì‹¤í–‰'ì´ë¼ëŠ” ë™ì¼í•œ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì§€ë§Œ, ê·¸ ì ‘ê·¼ ë°©ì‹ê³¼ ì² í•™ì— ì°¨ì´ê°€ ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

### ê²°ë¡ 

`UseWhen`ì€ ASP.NET Coreì—ì„œ ë™ì ìœ¼ë¡œ ìš”ì²­ íŒŒì´í”„ë¼ì¸ì„ êµ¬ì„±í•  ìˆ˜ ìˆëŠ” ê°•ë ¥í•˜ê³  ìœ ì—°í•œ ë„êµ¬ë‹¤. ëª¨ë“  ìš”ì²­ì— ë™ì¼í•œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì ìš©í•˜ëŠ” ëŒ€ì‹ , íŠ¹ì • ì¡°ê±´ì— ë”°ë¼ í•„ìš”í•œ ë¡œì§ë§Œ ì„ íƒì ìœ¼ë¡œ ì‹¤í–‰í•¨ìœ¼ë¡œì¨ ë” ê¹”ë”í•˜ê³  íš¨ìœ¨ì ì¸ ì½”ë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.